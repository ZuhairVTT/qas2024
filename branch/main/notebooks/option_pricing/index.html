

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pricing a European call option on a quantum computer &mdash; Quantum Autumn School 2024  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_lesson.css?v=e9df6548" />
      <link rel="stylesheet" type="text/css" href="../../_static/term_role_formatting.css?v=4194e21c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx_rtd_theme_ext_color_contrast.css?v=8e8ea19f" />
      <link rel="stylesheet" type="text/css" href="../../_static/overrides.css?v=0572569b" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=187304be"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/minipres.js?v=a0d29692"></script>
      <script>let toggleHintShow = 'Click to show';</script>
      <script>let toggleHintHide = 'Click to hide';</script>
      <script>let toggleOpenOnPrint = 'true';</script>
      <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
      <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script data-domain="enccs.github.io/qas2024" defer="defer" src="https://plausible.io/js/script.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Tutorial - Pricing a European call option using quantum computing" href="../option_pricing_tutorial/" />
    <link rel="prev" title="Quantum Monte Carlo and quantum finance" href="../../qmc_fin/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../" class="icon icon-home">
            Quantum Autumn School 2024
              <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Setup</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup/">Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../welcome/">Welcome and introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc_qc/">Integration of High Performance Computing and Quantum Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helmi/">Introduction to Helmi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GHZ_Estimator_Attendees/">Tutorial - Introduction to Helmi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qaoa_vqe_intro/">Introduction to variational quantum algorithms: VQE and QAOA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../QAS2024_QAOA_exercise/">Tutorial - Variational Quantum Algorithms</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 2</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Decoding_excercise/">Tutorial - MAP Decoding Exercise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../css_code_steane/">Tutorial - Fault-Tolerant Quantum Computing with CSS codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_code_threshold/">Tutorial - Estimating the Surface Code Threshold</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qmc_fin/">Quantum Monte Carlo and quantum finance</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pricing a European call option on a quantum computer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#encoding-the-probability-distribution">Encoding the probability distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#combining-the-distribution-and-payoff-circuits">Combining the distribution and payoff circuits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#amplitude-estimation">Amplitude estimation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#convergence-rate-of-classical-monte-carlo">Convergence rate of Classical Monte Carlo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Amplitude estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-qae-on-local-simulator">Run QAE on local simulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="#iterative-quantum-amplitude-estimation">Iterative quantum amplitude estimation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../option_pricing_tutorial/">Tutorial - Pricing a European call option using quantum computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qsip/">QSIP - Quantum Sweden Innovation Platform</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Day 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../flight_scheduling_optimization_qaoa/">Tutorial - Solving Flight Scheduling Optimization using QAOA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qwalks/">Quantum walks on quantum computers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tergite-overview/">Tergite overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cos/">Distributed Quantum Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qelm/">Quantum extreme learning machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../matsci_on_qc/README/">Quantum Computing for Materials Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ihpc/">Quantum Computing Activities of NCC Iceland</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://enccs.se/lessons/">All ENCCS lessons</a></li>
<li class="toctree-l1"><a class="reference external" href="https://enccs.se/">About ENCCS</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Quantum Autumn School 2024</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Pricing a European call option on a quantum computer</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/qas2024/blob/main/content/notebooks/option_pricing.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="pricing-a-european-call-option-on-a-quantum-computer">
<h1>Pricing a European call option on a quantum computer<a class="headerlink" href="#pricing-a-european-call-option-on-a-quantum-computer" title="Link to this heading">ÔÉÅ</a></h1>
<p>This notebook is based on the work of M. Q. Hlatshwayo, NQCC.</p>
<p>A call option is a financial contract in which the holder (buyer) has the right (but not the obligation) to buy a specified quantity of a security at a specified price (strike price) within a fixed period of time (until its expiration).</p>
<p>For the writer (seller) of a call option, it represents an obligation to sell the underlying security at the strike price if the option is exercised. The call option writer is paid a premium for taking on the risk associated with the obligation.</p>
<p>Suppose a European call option with strike price <span class="math notranslate nohighlight">\(K\)</span> and an underlying asset whose spot price at maturity <span class="math notranslate nohighlight">\(S_T\)</span> follows a given distribution.
The corresponding payoff function is defined as:</p>
<div class="math notranslate nohighlight">
\[f(S_T) = \max(S_T - K, 0)\]</div>
<p>In the following, a quantum algorithm based on amplitude estimation is used to estimate the expected payoff, i.e., the fair price before discounting, for the option:</p>
<div class="math notranslate nohighlight">
\[\mathbb{E}\left[f(S_T) \right] \approx \frac{1}{N} \sum_{i=1}^{N} f\left(S_T^{(i)}\right). \]</div>
<p>The approximation of the objective function and a general introduction to option pricing and risk analysis on quantum computers are given in the following papers:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.nature.com/articles/s41534-019-0130-6">Quantum Risk Analysis. Woerner, Egger. 2018.</a></p></li>
<li><p><a class="reference external" href="https://quantum-journal.org/papers/q-2020-07-06-291/">Option Pricing using Quantum Computers. Stamatopoulos et al. 2019.</a></p></li>
</ul>
<section id="encoding-the-probability-distribution">
<h2>Encoding the probability distribution<a class="headerlink" href="#encoding-the-probability-distribution" title="Link to this heading">ÔÉÅ</a></h2>
<p>We construct a circuit to load a log-normal random distribution into a quantum state.
The distribution is truncated to a given interval <span class="math notranslate nohighlight">\([x_{min}, x_{max}]\)</span> and discretized using <span class="math notranslate nohighlight">\(2^n\)</span> grid points, where <span class="math notranslate nohighlight">\(n\)</span> denotes the number of qubits used.
The unitary operator corresponding to the circuit implements the following:</p>
<div class="math notranslate nohighlight">
\[\big|0\rangle_{n} \mapsto \big|\psi\rangle_{n} = \sum_{i=0}^{2^n-1} \sqrt{p_i}\big|i\rangle_{n},\]</div>
<p>where <span class="math notranslate nohighlight">\(p_i\)</span> denote the probabilities corresponding to the truncated and discretized distribution and where <span class="math notranslate nohighlight">\(i\)</span> is mapped to the right interval using the affine map:</p>
<div class="math notranslate nohighlight">
\[ \{0, \ldots, 2^n-1\} \ni i \mapsto \frac{x_{max} - x_{min}}{2^n - 1} * i + x_{min} \in [x_{min}, x_{max}].\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">qiskit_finance.circuit.library</span> <span class="kn">import</span> <span class="n">LogNormalDistribution</span>
<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">QuantumRegister</span><span class="p">,</span> <span class="n">ClassicalRegister</span><span class="p">,</span> <span class="n">AncillaRegister</span>
<span class="kn">from</span> <span class="nn">qiskit.circuit.library</span> <span class="kn">import</span> <span class="n">LinearAmplitudeFunction</span><span class="p">,</span> <span class="n">QFT</span><span class="p">,</span> <span class="n">GroverOperator</span>
<span class="kn">from</span> <span class="nn">qiskit_algorithms</span> <span class="kn">import</span> <span class="n">EstimationProblem</span><span class="p">,</span> <span class="n">IterativeAmplitudeEstimation</span>
<span class="kn">from</span> <span class="nn">qiskit.visualization</span> <span class="kn">import</span> <span class="n">plot_distribution</span>
<span class="kn">from</span> <span class="nn">qiskit.primitives</span> <span class="kn">import</span> <span class="n">StatevectorSampler</span> <span class="k">as</span> <span class="n">Sampler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># number of qubits to represent the stock price</span>
<span class="n">num_uncertainty_qubits</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># parameters for considered random distribution</span>
<span class="n">S</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># initial spot price</span>
<span class="n">vol</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># volatility of 40%</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># annual interest rate of 4%</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">/</span> <span class="mi">365</span>  <span class="c1"># 40 days to maturity</span>

<span class="c1"># resulting parameters for log-normal distribution</span>
<span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">vol</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">T</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">stddev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span>

<span class="c1"># lowest and highest value considered for the spot price; in between, an equidistant discretization is considered.</span>
<span class="n">low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mean</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">stddev</span><span class="p">)</span>
<span class="n">high</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">stddev</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct A operator for QAE for the payoff function by</span>
<span class="c1"># composing the uncertainty model and the objective</span>
<span class="n">uncertainty_model</span> <span class="o">=</span> <span class="n">LogNormalDistribution</span><span class="p">(</span>
    <span class="n">num_uncertainty_qubits</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view circuit </span>
<span class="n">uncertainty_model</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0f353999f1c36b173de0e56c44069a7cf0cdf63c4b05cf16649988a8f56eea6a.png" src="../../_images/0f353999f1c36b173de0e56c44069a7cf0cdf63c4b05cf16649988a8f56eea6a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view detailed circuit in terms of basis gates</span>
<span class="n">uncertainty_model</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7f135987213831143848ff2b87d095b6bccf629f72f3fe53e6c34bc382b555f9.png" src="../../_images/7f135987213831143848ff2b87d095b6bccf629f72f3fe53e6c34bc382b555f9.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="c1"># plot probability distribution</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">uncertainty_model</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">uncertainty_model</span><span class="o">.</span><span class="n">probabilities</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Spot Price at Maturity $S_T$ (EUR)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Probability ($\%$)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b7ccf8bf6e31cf49b12e8ee49177525860e36590193f537455f8de8c6a90cfc2.png" src="../../_images/b7ccf8bf6e31cf49b12e8ee49177525860e36590193f537455f8de8c6a90cfc2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the strike price (should be within the low and the high value of the uncertainty)</span>
<span class="n">strike_price</span> <span class="o">=</span> <span class="mf">1.896</span>

<span class="c1"># plot exact payoff function (evaluated on the grid of the uncertainty model)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">uncertainty_model</span><span class="o">.</span><span class="n">values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="n">strike_price</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;ro-&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Payoff Function&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Spot Price at Maturity $S_T$ (EUR)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Payoff Amount (EUR)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/983f731ca9bf5e9adb04491be1be14a00ef3e991e412d1ac046d77ff8a6f4900.png" src="../../_images/983f731ca9bf5e9adb04491be1be14a00ef3e991e412d1ac046d77ff8a6f4900.png" />
</div>
</div>
<p>The payoff function equals zero as long as the spot price at maturity <span class="math notranslate nohighlight">\(S_T\)</span> is less than the strike price <span class="math notranslate nohighlight">\(K\)</span> and then increases linearly.
The implementation uses a comparator, that flips an ancilla qubit from <span class="math notranslate nohighlight">\(\big|0\rangle\)</span> to <span class="math notranslate nohighlight">\(\big|1\rangle\)</span> if <span class="math notranslate nohighlight">\(S_T \geq K\)</span>, and this ancilla is used to control the linear part of the payoff function.</p>
<p>Eventually, we are interested in the probability of measuring <span class="math notranslate nohighlight">\(\big|1\rangle\)</span> in the last qubit. Recall that</p>
<div class="math notranslate nohighlight">
\[ \mathbb{P}(\textrm{measure 1}) = \mathbb{E}[f(X)] = \sum_{i=0}^{2^n-1}f(i)p_i.\]</div>
<p>For more details on the implementation, we refer to:</p>
<p><a class="reference external" href="https://docs.quantum.ibm.com/api/qiskit/qiskit.circuit.library.LinearAmplitudeFunction">LinearAmplitudeFunction | IBM Qiskit Documentation</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the approximation scaling for the payoff function</span>
<span class="n">c_approx</span> <span class="o">=</span> <span class="mf">0.25</span>

<span class="c1"># setup piecewise linear objective function</span>
<span class="n">breakpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">strike_price</span><span class="p">]</span>
<span class="n">slopes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">offsets</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">f_min</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">f_max</span> <span class="o">=</span> <span class="n">high</span> <span class="o">-</span> <span class="n">strike_price</span>
<span class="n">european_call_objective</span> <span class="o">=</span> <span class="n">LinearAmplitudeFunction</span><span class="p">(</span>
    <span class="n">num_uncertainty_qubits</span><span class="p">,</span>
    <span class="n">slopes</span><span class="p">,</span>
    <span class="n">offsets</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">),</span>
    <span class="n">image</span><span class="o">=</span><span class="p">(</span><span class="n">f_min</span><span class="p">,</span> <span class="n">f_max</span><span class="p">),</span>
    <span class="n">breakpoints</span><span class="o">=</span><span class="n">breakpoints</span><span class="p">,</span>
    <span class="n">rescaling_factor</span><span class="o">=</span><span class="n">c_approx</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view payoff function circuit</span>
<span class="n">european_call_objective</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s1">&#39;mpl&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9e2a31dc91d9118a18cc3567b6c9b7ffc5ab2eafc06276af757427e5519e3369.png" src="../../_images/9e2a31dc91d9118a18cc3567b6c9b7ffc5ab2eafc06276af757427e5519e3369.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view payoff function circuit</span>
<span class="n">function_circuit</span> <span class="o">=</span> <span class="n">european_call_objective</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
<span class="n">function_circuit</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/db5266744d324385665a73eae9cb55c9e6df93a06acec9da49b48e77a32bae56.png" src="../../_images/db5266744d324385665a73eae9cb55c9e6df93a06acec9da49b48e77a32bae56.png" />
</div>
</div>
</section>
<section id="combining-the-distribution-and-payoff-circuits">
<h2>Combining the distribution and payoff circuits<a class="headerlink" href="#combining-the-distribution-and-payoff-circuits" title="Link to this heading">ÔÉÅ</a></h2>
<p>We combine the circuits for the underlying distribution and the payoff function, respectively. The <span class="math notranslate nohighlight">\(q\)</span> qubit contains the expected value of the payoff. We add a measurement operator for <span class="math notranslate nohighlight">\(q\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct A operator for QAE for the payoff function by</span>
<span class="c1"># composing the uncertainty model and the objective</span>
<span class="n">num_qubits</span> <span class="o">=</span> <span class="n">european_call_objective</span><span class="o">.</span><span class="n">num_qubits</span>
<span class="n">num_clbits</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">qreg</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="n">num_uncertainty_qubits</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
<span class="n">qreg2</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">)</span>
<span class="n">qreg3</span> <span class="o">=</span> <span class="n">AncillaRegister</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">-</span><span class="n">num_uncertainty_qubits</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">creg</span> <span class="o">=</span> <span class="n">ClassicalRegister</span><span class="p">(</span><span class="n">num_clbits</span><span class="p">,</span> <span class="s1">&#39;creg&#39;</span><span class="p">)</span>
<span class="n">european_call</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">qreg</span><span class="p">,</span> <span class="n">qreg2</span><span class="p">,</span> <span class="n">qreg3</span><span class="p">)</span>
<span class="n">european_call</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uncertainty_model</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_uncertainty_qubits</span><span class="p">))</span>
<span class="n">european_call</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">european_call_objective</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">))</span>
<span class="n">european_call</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7664478dd822002b0129c9b32715f73325ab8a83ed630b1c2a73cb269ff8e244.png" src="../../_images/7664478dd822002b0129c9b32715f73325ab8a83ed630b1c2a73cb269ff8e244.png" />
</div>
</div>
<p>We can add a measurement to the objective qubit, in order to run the combined circuit and calculate the average <span class="math notranslate nohighlight">\(\hat p\)</span>. The average is scaled back from the <span class="math notranslate nohighlight">\([0,1]\)</span> interval to the original <span class="math notranslate nohighlight">\([x_{min}, x_{max}]\)</span> interval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add a measurement to the objective qubit</span>
<span class="n">measured_european_call</span> <span class="o">=</span> <span class="n">european_call</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">measured_european_call</span><span class="o">.</span><span class="n">add_register</span><span class="p">(</span><span class="n">creg</span><span class="p">)</span>
<span class="n">measured_european_call</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">qreg2</span><span class="p">,</span> <span class="n">creg</span><span class="p">)</span>
<span class="c1"># draw the circuit</span>
<span class="n">measured_european_call</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="s2">&quot;mpl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2e128744a8cb1842892dea288139817b050b8f0767cb4578f37e6acd4561f198.png" src="../../_images/2e128744a8cb1842892dea288139817b050b8f0767cb4578f37e6acd4561f198.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run on local simulator</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">()</span>
<span class="n">n_shots</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">measured_european_call</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="n">n_shots</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">creg</span><span class="o">.</span><span class="n">get_int_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_distribution</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9287e76589832fd113ee8f799bb8bf21b5a368d32dd4c7156a161cfa3003c739.png" src="../../_images/9287e76589832fd113ee8f799bb8bf21b5a368d32dd4c7156a161cfa3003c739.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p_hat</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">n_shots</span>
<span class="n">p_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_hat</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p_hat</span><span class="p">)</span><span class="o">/</span><span class="n">n_shots</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;raw estimated average:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">p_hat</span><span class="p">,</span> <span class="s2">&quot;, standard deviation:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">p_std</span><span class="p">)</span>

<span class="n">expectation</span> <span class="o">=</span> <span class="n">european_call_objective</span><span class="o">.</span><span class="n">post_processing</span><span class="p">(</span><span class="n">p_hat</span><span class="p">)</span>
<span class="n">upper</span> <span class="o">=</span> <span class="n">european_call_objective</span><span class="o">.</span><span class="n">post_processing</span><span class="p">(</span><span class="n">p_hat</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">p_std</span><span class="p">)</span>
<span class="n">lower</span> <span class="o">=</span> <span class="n">european_call_objective</span><span class="o">.</span><span class="n">post_processing</span><span class="p">(</span><span class="n">p_hat</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">p_std</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;estimation of expected payoff:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expectation</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lower confidence bound:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">lower</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;upper confidence bound:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">upper</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>raw estimated average:	0.3653 , standard deviation:	0.0048
estimation of expected payoff:	0.1440
lower confidence bound:	0.1215
upper confidence bound:	0.1665
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># evaluate exact expected value (normalized to the [0, 1] interval)</span>
<span class="n">exact_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">uncertainty_model</span><span class="o">.</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;exact expected value from discretization:</span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exact_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>exact expected value from discretization:	0.1623
</pre></div>
</div>
</div>
</div>
</section>
<section id="amplitude-estimation">
<h2>Amplitude estimation<a class="headerlink" href="#amplitude-estimation" title="Link to this heading">ÔÉÅ</a></h2>
<section id="convergence-rate-of-classical-monte-carlo">
<h3>Convergence rate of Classical Monte Carlo<a class="headerlink" href="#convergence-rate-of-classical-monte-carlo" title="Link to this heading">ÔÉÅ</a></h3>
<p>The standard Monte Carlo method for pricing consists in approximating the expected payoff <span class="math notranslate nohighlight">\(\mu = \mathbb{E}[f(S_T)]\)</span> as
$<span class="math notranslate nohighlight">\( \mu \approx \tilde{\mu}_N = \frac1{N} \sum_{i=1}^{N} f\left(S_T^{(i)} \right)\)</span>$</p>
<p>where <span class="math notranslate nohighlight">\(S_T^{(i)},  i=1,...,N \)</span> are independent, identically distributed samples from the probability distribution of the underlying asset <span class="math notranslate nohighlight">\(S\)</span> at the expiration time <span class="math notranslate nohighlight">\(T\)</span>.</p>
<p>A consequence of the central limit theorem is that the estimation error of the Monte Carlo method satisfies
$<span class="math notranslate nohighlight">\( \left|\tilde{\mu}_N-\mu \right| \sim \mathcal{O}\left(\frac1{\sqrt{N}}\right). \)</span>$</p>
</section>
<section id="id1">
<h3>Amplitude estimation<a class="headerlink" href="#id1" title="Link to this heading">ÔÉÅ</a></h3>
<p>Quantum amplitude estimation (QAE) is a quantum algorithm that provides an alternative to classical Monte Carlo in order to compute approximate expectations of random variables.</p>
<p>Suppose we are able to construct a circuit that implements an operator acting on an (n+1) qubit register as follows
$<span class="math notranslate nohighlight">\(
    \mathcal{U}|0\rangle_{n+1} = \sqrt{1 - a}\ket{\psi_0}_n \ket{0}+ \sqrt{a}\ket{\psi_1}_n\ket{1},
\)</span><span class="math notranslate nohighlight">\(
where \)</span>a\in [0,1]<span class="math notranslate nohighlight">\( is an unknown quantity associated with the value \)</span>\mu<span class="math notranslate nohighlight">\( which we intend to estimate (e.g., an appropriate re-scaling of \)</span>\mu<span class="math notranslate nohighlight">\( to the interval \)</span>[0,1]$).</p>
<p>Then, QAE can be used to obtain an estimate of <span class="math notranslate nohighlight">\(a\)</span> through repeated controlled applications of the grover operator
$<span class="math notranslate nohighlight">\(
    Q = \mathcal{U} S_0 \mathcal{U}^{\dagger}S_{\Psi_0}
\)</span>$
and an inverse quantum Fourier transform.</p>
<p>For further details on the algorithm, the reader is refered to <a class="reference external" href="https://arxiv.org/abs/quant-ph/0005055">Quantum Amplitude Amplification and Estimation. Brassard et. al.</a></p>
<p>It can be shown that, with high probability (<span class="math notranslate nohighlight">\(8/\pi^2 \approx 81\%\)</span>), the estimate <span class="math notranslate nohighlight">\(\tilde{a}_M\)</span> provided by QAE satisfies
$<span class="math notranslate nohighlight">\(
\left| \tilde{a}_M-a\right| \le \frac{2\pi\sqrt{a(1-a)}}{M} + \frac{\pi^2}{M^2}  \sim \mathcal{O}\left(\frac{1}{M}\right),
\)</span><span class="math notranslate nohighlight">\(
where \)</span>M=2^m<span class="math notranslate nohighlight">\(, and \)</span>m$ is the number of ancilla qubits used by the algorithm.</p>
<p>That is, QAE provides a quadratic speedup over classical Monte Carlo.</p>
<p>QAE can be applied to the circuit constructed above, which encodes the expected payoff into the amplitude of the objective qubit. To this end, we decompose the circuit into basis gates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">european_call</span> <span class="o">=</span> <span class="n">european_call</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Then, the QAE circuit can be constructed (you can look at the provided code <code class="docutils literal notranslate"><span class="pre">ae_circuit.py</span></code> to see how this is done).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AECircuit</span><span class="p">(</span><span class="n">QuantumCircuit</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_preparation_circuit</span><span class="p">,</span> <span class="n">num_ancilla_qubits</span><span class="p">,</span> <span class="n">objective_qubit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_preparation_circuit</span> <span class="o">=</span> <span class="n">state_preparation_circuit</span> <span class="c1"># The cirtuit implementing operator A</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ancilla_qubits</span> <span class="o">=</span> <span class="n">num_ancilla_qubits</span> <span class="c1"># Number of ancilla qubits (m in IQAE paper)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_state_qubits</span> <span class="o">=</span> <span class="n">state_preparation_circuit</span><span class="o">.</span><span class="n">num_qubits</span> <span class="c1"># Number of qubits in circuit A (n+1 in the IQAE paper)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">objective_qubit</span> <span class="o">=</span> <span class="n">objective_qubit</span> <span class="c1"># Index of the objective qubit within the circuit A (0&lt;=objective_qubit&lt;=num_state_qubits) </span>
   
        <span class="c1"># Initialize circuit </span>
        <span class="n">ancilla_register</span> <span class="o">=</span> <span class="n">AncillaRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ancilla_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ancilla&quot;</span><span class="p">)</span>
        <span class="n">state_register</span> <span class="o">=</span> <span class="n">QuantumRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_state_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>
        <span class="n">classical_register</span> <span class="o">=</span> <span class="n">ClassicalRegister</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ancilla_qubits</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;creg&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">ancilla_register</span><span class="p">,</span>
            <span class="n">state_register</span><span class="p">,</span>
            <span class="n">classical_register</span>
        <span class="p">)</span>
        
        <span class="c1"># Hadamard gates on the ancilla qubits</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ancilla_qubits</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">ancilla_register</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            
        <span class="c1"># Circuit A on the state and objective qubits</span>
        <span class="n">A_gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_preparation_circuit</span><span class="o">.</span><span class="n">to_gate</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$A$&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A_gate</span><span class="p">,</span> <span class="n">state_register</span><span class="p">[:])</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        
        <span class="c1"># Powers of Q</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groverOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_preparation_circuit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">objective_qubit</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ancilla_qubits</span><span class="p">):</span>
            <span class="n">Qj</span> <span class="o">=</span> <span class="n">Q</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">to_gate</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$Q^</span><span class="se">{{</span><span class="si">{</span><span class="mi">2</span><span class="o">**</span><span class="n">j</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">control</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Controlled version of Q^{2j}</span>
            <span class="c1"># Apply the controlled Q^{2j} gate on state and objective qubits, controlled by the j-th ancilla qubit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Qj</span><span class="p">,</span> <span class="p">[</span><span class="n">ancilla_register</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ancilla_qubits</span><span class="o">-</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">state_register</span><span class="p">[:])</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
       
        <span class="c1"># Inverse QFT</span>
        <span class="n">QFT_gate</span> <span class="o">=</span> <span class="n">QFT</span><span class="p">(</span><span class="n">num_qubits</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ancilla_qubits</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_swaps</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_gate</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;$QFT^\dagger$&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">QFT_gate</span><span class="p">,</span> <span class="n">ancilla_register</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
        
        <span class="c1"># Measure the ancilla qubits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">ancilla_register</span><span class="p">,</span> <span class="n">classical_register</span><span class="p">)</span>
       
    <span class="k">def</span> <span class="nf">groverOp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_preparation_circuit</span><span class="p">,</span> <span class="n">objective_qubit</span><span class="p">):</span>
        <span class="c1"># construct the grover operator</span>
        <span class="n">oracle</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">state_preparation_circuit</span><span class="o">.</span><span class="n">num_qubits</span> <span class="o">-</span> <span class="n">state_preparation_circuit</span><span class="o">.</span><span class="n">num_ancillas</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">oracle</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">objective_qubit</span><span class="p">)</span>
        <span class="n">oracle</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">objective_qubit</span><span class="p">)</span>
        <span class="n">oracle</span><span class="o">.</span><span class="n">h</span><span class="p">(</span><span class="n">objective_qubit</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">GroverOperator</span><span class="p">(</span><span class="n">oracle</span><span class="p">,</span> <span class="n">state_preparation_circuit</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">Q</span>
    
<span class="n">num_ancilla_qubits</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">qae</span> <span class="o">=</span> <span class="n">AECircuit</span><span class="p">(</span><span class="n">state_preparation_circuit</span><span class="o">=</span><span class="n">european_call</span><span class="p">,</span> <span class="n">num_ancilla_qubits</span><span class="o">=</span><span class="n">num_ancilla_qubits</span><span class="p">,</span> <span class="n">objective_qubit</span><span class="o">=</span><span class="n">num_uncertainty_qubits</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qae</span><span class="o">.</span><span class="n">decompose</span><span class="p">(</span><span class="n">reps</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">depth</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>454840
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-qae-on-local-simulator">
<h3>Run QAE on local simulator<a class="headerlink" href="#run-qae-on-local-simulator" title="Link to this heading">ÔÉÅ</a></h3>
<p>We can run QAE on our local simulator, and check that the estimator it produces is close to the MC estimator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run on local simulator</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">()</span>
<span class="n">n_shots</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">qae</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="n">n_shots</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">counts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">creg</span><span class="o">.</span><span class="n">get_int_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># QAE post-processing</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">num_ancilla_qubits</span> <span class="c1"># Number of grid points = 2^num_ancilla_qubits</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">theta_estimates</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">M</span>
<span class="n">estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_estimates</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

<span class="c1"># Combine duplicates</span>
<span class="n">new_estimates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">estimates</span><span class="p">))</span>
<span class="n">new_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="n">estimates</span><span class="o">==</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_estimates</span><span class="p">]</span>
<span class="n">estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_estimates</span><span class="p">)</span>
<span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_probabilities</span><span class="p">)</span>

<span class="n">p_mode</span> <span class="o">=</span> <span class="n">estimates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)]</span> <span class="c1"># Extract estimate with highest probability</span>
<span class="n">qae_expected_payoff</span> <span class="o">=</span> <span class="n">european_call_objective</span><span class="o">.</span><span class="n">post_processing</span><span class="p">(</span><span class="n">p_mode</span><span class="p">)</span> <span class="c1"># Re-scale estimate to get expected payoff</span>
<span class="n">qae_expected_payoff</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>np.float64(0.17487657133764406)
</pre></div>
</div>
</div>
</div>
<p>We can compute the accuracy of QAE as a function of quantum samples</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">estimate_ae</span><span class="p">(</span><span class="n">num_ancilla_qubits</span><span class="p">):</span>
    <span class="c1"># Construct QAE circuit</span>
    <span class="n">qae</span> <span class="o">=</span> <span class="n">AECircuit</span><span class="p">(</span><span class="n">state_preparation_circuit</span><span class="o">=</span><span class="n">european_call</span><span class="p">,</span> <span class="n">num_ancilla_qubits</span><span class="o">=</span><span class="n">num_ancilla_qubits</span><span class="p">,</span> <span class="n">objective_qubit</span><span class="o">=</span><span class="n">num_uncertainty_qubits</span><span class="p">)</span>
    
    <span class="c1"># Run on local simulator</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">()</span>
    <span class="n">n_shots</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">qae</span><span class="p">],</span> <span class="n">shots</span><span class="o">=</span><span class="n">n_shots</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">creg</span><span class="o">.</span><span class="n">get_int_counts</span><span class="p">()</span>
    
    <span class="c1"># Post-processing </span>
    <span class="n">M</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">num_ancilla_qubits</span> <span class="c1"># Number of grid points = 2^num_ancilla_qubits</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">theta_estimates</span> <span class="o">=</span> <span class="n">q</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">M</span>
    <span class="n">estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_estimates</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float64&quot;</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

    <span class="c1"># Combine duplicates</span>
    <span class="n">new_estimates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">estimates</span><span class="p">))</span>
    <span class="n">new_probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probabilities</span><span class="p">[</span><span class="n">estimates</span><span class="o">==</span><span class="n">e</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_estimates</span><span class="p">]</span>
    <span class="n">estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_estimates</span><span class="p">)</span>
    <span class="n">probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_probabilities</span><span class="p">)</span>

    <span class="n">p_mode</span> <span class="o">=</span> <span class="n">estimates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)]</span> <span class="c1"># Extract estimate with highest probability</span>
    <span class="k">return</span> <span class="n">p_mode</span>

<span class="n">ancillas_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">qae_estimates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">estimate_ae</span><span class="p">(</span><span class="n">num_ancilla_qubits</span><span class="p">)</span> <span class="k">for</span> <span class="n">num_ancilla_qubits</span> <span class="ow">in</span> <span class="n">ancillas_range</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot results</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ancillas_range</span><span class="p">)</span>
<span class="n">qae_expected_payoffs</span> <span class="o">=</span> <span class="n">qae_estimates</span>

<span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ancillas_range</span><span class="p">),</span> <span class="n">qae_expected_payoffs</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># QAE estimates</span>

<span class="c1"># Confidence intervals</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ancillas_range</span><span class="p">)</span>
<span class="n">confidence_intervals</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qae_estimates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qae_estimates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">/</span><span class="n">M</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">M</span><span class="o">**</span><span class="mi">2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">qae_estimates</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">confidence_intervals</span><span class="p">),</span> <span class="n">qae_estimates</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">confidence_intervals</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$M=2^m$&quot;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;QAE estimates&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/645d4eeeeb12b17bc5cc470b80221493bebc41eb373e6ea949a6890f9b74d9d7.png" src="../../_images/645d4eeeeb12b17bc5cc470b80221493bebc41eb373e6ea949a6890f9b74d9d7.png" />
</div>
</div>
<p><strong>Some thoughts</strong></p>
<p>Look at the depth of the QAE circuit. Is this algorithm NISQ-ready?</p>
<p>There are some more advanced versions of QAE, which attempt to reduce the required circuit depth without compromising accuracy. We refer the interested reader to</p>
<ul class="simple">
<li><p><a class="reference external" href="https://arxiv.org/abs/1904.10246">Amplitude estimation without phase estimation. Suzuki et. al.</a>,</p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/2003.02417">Faster Amplitude Estimation. Nakaji.</a>,</p></li>
<li><p><a class="reference external" href="https://arxiv.org/abs/1912.05559">Iterative Quantum Amplitude Estimation. Grinko et. al.</a>.</p></li>
</ul>
</section>
<section id="iterative-quantum-amplitude-estimation">
<h3>Iterative quantum amplitude estimation<a class="headerlink" href="#iterative-quantum-amplitude-estimation" title="Link to this heading">ÔÉÅ</a></h3>
<p><a class="reference external" href="https://arxiv.org/abs/1912.05559">Iterative quantum amplitude estimation (IQAE)</a> uses the same ideas as canonical QAE while reducing the while reducing circuit depth and the required number of ancillas.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">qiskit_algorithms</span></code> module implements the method <a class="reference external" href="https://qiskit-community.github.io/qiskit-algorithms/stubs/qiskit_algorithms.IterativeAmplitudeEstimation.html"><code class="docutils literal notranslate"><span class="pre">IterativeAmplitudeEstimation</span></code></a>, which can be used to estimate the expected payoff as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">qiskit_aer.primitives</span> <span class="kn">import</span> <span class="n">Sampler</span>

<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="n">problem</span> <span class="o">=</span> <span class="n">EstimationProblem</span><span class="p">(</span>
    <span class="n">state_preparation</span><span class="o">=</span><span class="n">european_call</span><span class="p">,</span>
    <span class="n">objective_qubits</span><span class="o">=</span><span class="p">[</span><span class="n">num_uncertainty_qubits</span><span class="p">],</span>
    <span class="n">post_processing</span><span class="o">=</span><span class="n">european_call_objective</span><span class="o">.</span><span class="n">post_processing</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">iae</span> <span class="o">=</span> <span class="n">IterativeAmplitudeEstimation</span><span class="p">(</span>
    <span class="n">epsilon_target</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">Sampler</span><span class="p">(</span><span class="n">run_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shots&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">iae</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

<span class="n">conf_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">confidence_interval_processed</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exact value:        </span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">exact_value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimated value:    </span><span class="se">\t</span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">estimation_processed</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Confidence interval:</span><span class="se">\t</span><span class="s2">[</span><span class="si">%.4f</span><span class="s2">, </span><span class="si">%.4f</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">conf_int</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Exact value:        	0.1623
Estimated value:    	0.1676
Confidence interval:	[0.1615, 0.1737]
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../qmc_fin/" class="btn btn-neutral float-left" title="Quantum Monte Carlo and quantum finance" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../option_pricing_tutorial/" class="btn btn-neutral float-right" title="Tutorial - Pricing a European call option using quantum computing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>